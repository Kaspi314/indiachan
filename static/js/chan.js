!function(){"use strict";var t=window,e=t.document,n=t.timeago,s=t.$,i=t.axios,o=s("#floatingMenu"),a=s("#threadList"),l="page-thread"===e.body.id,r=function(t){return s(t&&t.response&&t.response.data).find("#errorLabel").html()||""},d=function(t){return t&&0<t.indexOf("captcha")},c=function(){s("#postingForm").removeClass("vis")},h=function(t){t.preventDefault();var e,a=t.target.pathname,n="",o=l;a&&(o=1,n=a.match(/\d+/)[0],e=t.target.hash.match(/\d+/)[0]);var i=s("#postingForm").addClass("vis");i.find(".formTitle span").html(o?"Reply":"New Thread"),i.find("form").prop("action",o?"/replyThread.js":"/newThread.js"),i.find("#formButton").html(o?"Reply":"Post"),l||i.find("#threadIdentifier").val(o?n:""),i.find("textarea").focus(),e&&(location.hash="q"+e)};s(".labelOmission").click(function(){var e=s(this);if(!e.hasClass("loading")){var a=e.closest(".opCell"),n=a.find(".divPosts");if(e.hasClass("loaded"))return n.toggleClass("compact"),e.html("Show/Hide"),p(a),e.toggleClass("open");e.addClass("loading"),i.get(f(a)).then(function(t){e.html("Showing all replies"),e.addClass("open loaded").removeClass("loading"),n.html(s(t.data).find(".divPosts").html()),u(n),p(a)})}});var f=function(t){return"/"+t.data("boarduri")+"/res/"+t.attr("id")+".html"};function p(t){var o={};for(var e in t.find(".quoteLink").each(function(t,e){var a=e.href.replace(/.+#/,""),n=s(e).closest(".postCell").attr("id");o[a]||(o[a]={}),o[a][n]=1}),o){var a="";for(var n in o[e])a+='<a href="'+f(t)+"#"+n+'">>>'+n+"</a>";e==t.attr("id")&&(e+=" .innerOP"),s("#"+e).find(".panelBacklinks").html(a)}}function u(t){t||(t=a),t.find(".labelCreated").each(function(t,e){try{var a=new Date(e.innerText.replace(/(\w+)\/(\w+)/,"$2/$1"));e.setAttribute("datetime",new Date(a.getTime()-60*a.getTimezoneOffset()*1e3).toISOString()),n().render(e)}catch(t){}})}function m(){s("#labelMessageLength").html(4096-s("#postingForm textarea").val().length)}function g(){var t=location.hash;if(t){var e="q"===t[1],a=t.slice(e?2:1);if(s(".markedPost").removeClass("markedPost"),s("#"+a+":not(.opCell) .innerPost").addClass("markedPost"),e){var n=s("#postingForm textarea")[0],o=">>"+a+"\n",i=n.value;i&&"\n"!==i[i.length-1]&&(o="\n"+o),n.value+=o,m()}}else c()}a.on("mouseover",".panelBacklinks a, .quoteLink",function(){var t=this.getBoundingClientRect(),e=s(this).prop("href").replace(/.+#/,""),a=s("#"+e);a=a.hasClass("opCell")?a.find(".innerOP").html():a.html(),o.css({left:t.right,top:t.bottom}).html(a).show()}).on("mouseout",".panelBacklinks a, .quoteLink",function(){o.hide()}).on("click",".innerUpload",function(t){t.preventDefault();var e=s(this),a=e.closest(".panelUploads");if(e.hasClass("loaded"))e.toggleClass("expanded"),a.toggleClass("expanded");else if(!e.hasClass("loading")){e.addClass("loading");var n=e.find(".imgLink"),o=n.data("filemime").slice(0,5),i=n.prop("href");s("image"===o?'<img class="origMedia" src="'+i+'">':"<"+o+' class="origMedia" src="'+i+'" autoplay controls muted></'+o+">").on("loadstart load",function(){e.hasClass("loading")&&(a.addClass("expanded"),e.addClass("loaded expanded").removeClass("loading"))}).prependTo(e)}}).on("click",".quickReply",h),s(".mainLink.quickReply").click(h),s(".catalogCell").click(function(){s(this).addClass("active")}),s("#postingForm textarea").on("input",m),s("#postingForm form").submit(function(t){t.preventDefault();var e=s(this).find(".btn");if(!e.prop("disabled")){k(e);var a=this.action,n={method:this.method,url:a,data:new FormData(this),headers:{"Content-Type":this.enctype}};i.request(n).catch(function(t){var e="Failed to post",a=r(t);if(d(a))return v(n);alert(e+=".\nReason: "+a)}).then(function(t){t&&function(t){s("#postingForm form")[0].reset(),m();var e,a=s(t);if(l){var n=(a=a.find(".postCell").last()).children(".innerPost").addClass("newPost");a.appendTo(".divPosts"),n.prop("offsetWidth"),n.removeClass("newPost")}else{a=a.find(".opCell");var o=s("#divThreads #"+a.attr("id"));o.length?(o.html(a.html()),e=(a=o).find(".postCell").last().attr("id")):a.prependTo("#divThreads")}location.hash="#"+(e||a.attr("id")),u(a),p(a),c()}(t.data),w(e)})}}),s(".opCell").each(function(t,e){p(s(e))}),s(".divMore").click(function(){s(this).toggleClass("open")}),s("#moreActions").click(function(){s("#divThreads").toggleClass("moreActions")}),u(),g(),onhashchange=g,s(".formTitle").click(c);var v=function(o){return new Promise(function(n,t){s("#captchaModal").show().on("submit",function(t){t.preventDefault();var a=s(this),e=a.find(".btn");e.prop("disabled")||(k(e),o.data.set("captcha",a.find("input").val()),i(o).then(function(t){s("#captchaModal").hide().off(),n(t)}).catch(function(t){var e=r(t);d(e)&&C(),a.find("span").html(e||"Error")}).then(function(){w(e)}))}),C()})},C=function(){return s("#captchaModal img").prop("src","/captcha.js?"+Date.now())},k=function(t){return t.prop("disabled",!0).addClass("loading")},w=function(t){return t.prop("disabled",!1).removeClass("loading")}}();
